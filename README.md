## Overview

Discount is a Spark-based tool for k-mer counting, and for analysis of minimizer orderings.

This software includes [Fastdoop](https://github.com/umbfer/fastdoop) by U.F. Petrillo et al [1].
We have also included some of the [DOCKS](http://acgt.cs.tau.ac.il/docks/) sets generated by Y Orenstein et al [2].
 
## Compiling

Discount has been developed and tested with JDK 8, Scala 2.11 and Spark 2.4.
In Google Cloud, we use Dataproc image version 1.4 (Debian 9, Hadoop 2.9, Spark 2.4).
In addition to a working Spark installation (http://spark.apache.org), 
the SBT build tool (https://www.scala-sbt.org/) is also needed.

Note that Spark 3.0 is not compatible with Scala 2.11. Currently, any 2.4.x version should be fine, e.g. 2.4.7.

The command `sbt package` will compile the software and produce the necessary jar file in 
target/scala-2.11/discount_2.11-1.0.0.jar. 

## Running

Copy spark-submit.sh.template to spark-submit.sh and edit the necessary variables in the file.
Alternatively, if you submit to a GCloud cluster, you can use submit-gcloud.sh.template. In that case,
edit the example commands below to use that script instead, and insert your GCloud cluster name as the first parameter.

## Usage (k-mer counting)

Example (statistical overview of a dataset) where k = 55, m = 10
 
`
./spark-submit.sh -m DOCKS/res_10_50_4_0.txt -k 55 -w 10 /path/to/data.fastq stats
`

This uses the universal frequency sampled ordering with the supplied DOCKS set res_10_50_4_0. For 
20 <= k < 50, res_10_20_4_0 should be used. For other combinations of m and k, please obtain a DOCKS set
using the link above.

For all of these commands, multiple input files may be supplied. FASTQ and FASTA are supported, and must be uncompressed.


Example (full counts table output with k-mer sequences)

`
./spark-submit.sh -m DOCKS/res_10_50_4_0.txt -k 55 -w 10 /path/to/data.fastq count -o /path/to/output/dir --sequence
`

A new directory called /path/to/output/dir_counts will be created with the output.

To get help:

`
./spark-submit.sh --help
`

## Usage (minimizer ordering evaluation)

`
./spark-submit.sh -m DOCKS/res_10_50_4_0.txt -k 55 -w 10 /path/to/data.fastq count -o /path/to/output/dir --write-stats
`

A new directory called /path/to/output/dir_stats will be created with the output.
Each line in the output file will represent a single k-mer bin. The output files will contain five columns, which are:
Number of superkmers, total number of k-mers, distinct k-mers, unique k-mers, maximum abundance for a single k-mer.
See the file BucketStats.scala for details. 


## References

1. Petrillo, U. F., Roscigno, G., Cattaneo, G., & Giancarlo, R. (2017). FASTdoop: A versatile and efficient library for the input of FASTA and FASTQ files for MapReduce Hadoop bioinformatics applications. Bioinformatics, 33(10), 1575–1577.
2. Orenstein, Y., Pellow, D., Marçais, G., Shamir, R., & Kingsford, C . (2017). Designing small universal k-mer hitting sets for improved analysis of high-throughput sequencing. PLoS Computational Biology, 13(10), 1–15. https://doi.org/10.1371/journal.pcbi.1005777
